FROM node:14-buster

WORKDIR /app

COPY package.json package-lock.json ./

RUN npm ci

COPY . ./

ARG GOOGLE_TAG_MANAGER_ID

ARG SITE_URL
ARG RECAPTCHA_TOKEN_HEADER
ARG RECAPTCHA_SITE_KEY
ARG RAVE_OF_PHONETICS_TRANSCRIBE_ENDPOINT
ARG RAVE_OF_PHONETICS_SUGGESTION_ENDPOINT
ARG GOOGLE_TAGMANAGER_ID
ARG NETLIFY_CMS_BACKEND_BRANCH
ARG NETLIFY_CMS_BACKEND_API_ROOT
ARG NETLIFY_CMS_BACKEND_BASE_URL
ARG NETLIFY_CMS_BACKEND_AUTH_ENDPOINT
ARG NETLIFY_CMS_COMMIT_LABEL_PREFIX

ENV SITE_URL $SITE_URL
ENV GATSBY_SITE_URL $SITE_URL

ENV RECAPTCHA_TOKEN_HEADER $RECAPTCHA_TOKEN_HEADER
ENV GATSBY_RECAPTCHA_TOKEN_HEADER $RECAPTCHA_TOKEN_HEADER

ENV RECAPTCHA_SITE_KEY $RECAPTCHA_SITE_KEY
ENV GATSBY_RECAPTCHA_SITE_KEY $RECAPTCHA_SITE_KEY

ENV RAVE_OF_PHONETICS_TRANSCRIBE_ENDPOINT $RAVE_OF_PHONETICS_TRANSCRIBE_ENDPOINT
ENV GATSBY_RAVE_OF_PHONETICS_TRANSCRIBE_ENDPOINT $RAVE_OF_PHONETICS_TRANSCRIBE_ENDPOINT

ENV RAVE_OF_PHONETICS_SUGGESTION_ENDPOINT $RAVE_OF_PHONETICS_SUGGESTION_ENDPOINT
ENV GATSBY_RAVE_OF_PHONETICS_SUGGESTION_ENDPOINT $RAVE_OF_PHONETICS_SUGGESTION_ENDPOINT

ENV GOOGLE_TAGMANAGER_ID $GOOGLE_TAGMANAGER_ID
ENV GATSBY_GOOGLE_TAGMANAGER_ID $GOOGLE_TAGMANAGER_ID

ENV NETLIFY_CMS_BACKEND_BRANCH $NETLIFY_CMS_BACKEND_BRANCH
ENV GATSBY_NETLIFY_CMS_BACKEND_BRANCH $NETLIFY_CMS_BACKEND_BRANCH

ENV NETLIFY_CMS_BACKEND_API_ROOT $NETLIFY_CMS_BACKEND_API_ROOT
ENV GATSBY_NETLIFY_CMS_BACKEND_API_ROOT $NETLIFY_CMS_BACKEND_API_ROOT

ENV NETLIFY_CMS_BACKEND_BASE_URL $NETLIFY_CMS_BACKEND_BASE_URL
ENV GATSBY_NETLIFY_CMS_BACKEND_BASE_URL $NETLIFY_CMS_BACKEND_BASE_URL

ENV NETLIFY_CMS_BACKEND_AUTH_ENDPOINT $NETLIFY_CMS_BACKEND_AUTH_ENDPOINT
ENV GATSBY_NETLIFY_CMS_BACKEND_AUTH_ENDPOINT $NETLIFY_CMS_BACKEND_AUTH_ENDPOINT

ENV NETLIFY_CMS_COMMIT_LABEL_PREFIX $NETLIFY_CMS_COMMIT_LABEL_PREFIX
ENV GATSBY_NETLIFY_CMS_COMMIT_LABEL_PREFIX $NETLIFY_CMS_COMMIT_LABEL_PREFIX

RUN npm run build

CMD npm run serve
